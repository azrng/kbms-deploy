import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as i,o as n,d as a}from"./app-CVU83naM.js";const e={},l=a(`<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€"><span>å‰è¨€</span></a></h2><p>åœ¨ä¸Šç¯‡æ–‡ç« æµ…è°ˆC#å–æ¶ˆä»¤ç‰ŒCancellationTokenSource[1]ä¸€æ–‡ä¸­æˆ‘ä»¬è®²è§£äº†CancellationTokenSourceï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ†å‘ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æˆ‘å–æ¶ˆä»¤ç‰Œæˆ‘å¯ä»¥è¿›è¡Œä¸€äº›å›è°ƒæ“ä½œæˆ–è€…é€šè¿‡ä»¤ç‰ŒçŠ¶æ€å¾—çŸ¥è¢«å–æ¶ˆã€‚åœ¨ä¸Šæ–‡çš„ç»“å°¾å¤„æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹CancellationTokenSourceäº§ç”Ÿçš„Tokenæ˜¯ä¸€æ¬¡æ€§çš„ï¼ŒCancelæ“ä½œä¹‹åå°±æ²¡åŠæ³•å†å¤ç”¨äº†ï¼Œåªèƒ½é‡Šæ”¾æ‰äº†ã€‚è€Œå¾®è½¯ä¹Ÿå¾ˆè´´å¿ƒçš„ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ¥è§£å†³è¿™é—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è¯´çš„æ›´æ”¹ä»¤ç‰ŒChangeTokenï¼Œå®ƒçœ‹èµ·æ¥å¯ä»¥è®©CancellationTokenSourceäº§ç”Ÿçš„Tokenå¤šæ¬¡è§¦å‘ï¼Œæœ¬æ–‡æˆ‘ä»¬å°±æ¥è®²è§£ChangeTokenç›¸å…³ã€‚</p><h2 id="ç®€å•å®ä¾‹" tabindex="-1"><a class="header-anchor" href="#ç®€å•å®ä¾‹"><span>ç®€å•å®ä¾‹</span></a></h2><p>è¦æƒ³æ›´å¥½çš„äº†è§£ä¸€ä¸ªæ–°çš„çŸ¥è¯†ï¼Œé¦–å…ˆçŸ¥é“å®ƒæ˜¯åšå•¥çš„ï¼Œå…¶æ¬¡è¦çŸ¥é“å®ƒæ€ä¹ˆåšã€‚æ‰€ä»¥è¿˜æ˜¯è€è§„çŸ©ï¼Œå’±ä»¬å…ˆé€šè¿‡ç®€å•çš„ç¤ºä¾‹å¼€å§‹ï¼Œè¿™æ ·æ›´æ–¹ä¾¿äº†è§£ã€‚ChangeTokenæœ¬èº«æ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå®ƒçš„æ ¸å¿ƒå…¥å£OnChangeæ–¹æ³•åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ä¼ é€’IChangeTokenæ¥å£å®ä¾‹æ¥è·å–ä»¤ç‰Œï¼Œå¦ä¸€ä¸ªæ˜¯ä»¤ç‰Œå–æ¶ˆä¹‹åè¿›è¡Œçš„å›è°ƒæ“ä½œã€‚åšä¸»æœ¬äººçŸ¥é“çš„å…³äºIChangeTokenæ¥å£çš„åœ¨CLRä¸­çš„å®ç°ç±»æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯CancellationChangeTokenå’ŒCompositeChangeTokenç±»ï¼Œæ¥ä¸‹æ¥å’±ä»¬å°±åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªç±»çš„ç®€å•ä½¿ç”¨ã€‚</p><h3 id="cancellationchangetokenç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#cancellationchangetokenç¤ºä¾‹"><span>CancellationChangeTokenç¤ºä¾‹</span></a></h3><p>å’±ä»¬å…ˆæ¥æ¼”ç¤ºCancellationChangeTokenç±»çš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ChangeTokençš„æœ€ç®€å•æ–¹å¼ã€‚é¦–å…ˆå®šä¹‰ä¸€ä¸ªTestCancellationChangeTokenç±»æ¥åŒ…è£…ä¸€ä¸‹CancellationChangeTokenï¼Œå®ç°å¦‚ä¸‹</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span></span></span>
<span class="line"><span>public class TestCancellationChangeToken</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    private CancellationTokenSource tokenSource;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// è·å–CancellationChangeTokenå®ä¾‹æ–¹æ³•</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public CancellationChangeToken CreatChanageToken()</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        tokenSource = new CancellationTokenSource();</span></span>
<span class="line"><span>        return new CancellationChangeToken(tokenSource.Token);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// å–æ¶ˆCancellationTokenSource</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public void CancelToken()</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        tokenSource.Cancel();</span></span>
<span class="line"><span>    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªç±»éå¸¸ç®€å•,åŒ…å«ä¸€ä¸ªCancellationTokenSourceç±»å‹çš„å±æ€§ï¼Œä¸€ä¸ªåˆ›å»ºCancellationChangeTokenå®ä¾‹çš„æ–¹æ³•å’Œä¸€ä¸ªå–æ¶ˆCancellationTokenSourceçš„CancelTokenæ–¹æ³•ã€‚æ³¨æ„çœ‹å®ç°çš„CreatChanageTokenæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„CancellationTokenSourceå’ŒCancellationChangeTokenå®ä¾‹ï¼Œåˆ›å»ºCancellationChangeTokenå®ä¾‹éœ€è¦ä¼ é€’CancellationTokenå®ä¾‹ã€‚CancelTokenæ–¹æ³•é‡Œæ˜¯è°ƒç”¨çš„CancellationTokenSourceçš„Cancelæ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨å®šä¹‰çš„è¿™ä¸ªç±»</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//å£°æ˜ç±»çš„å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TestCancellationChangeToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> cancellationChangeToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> TestCancellationChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> cancellationChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">CreatChanageToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(), () </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">System</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Console</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">WriteLine</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">$&quot;{</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">DateTime</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Now</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">HH</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mm</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ss</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}è¢«è§¦å‘å¯ä¸€æ¬¡&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//æ¨¡æ‹Ÿå¤šæ¬¡è°ƒç”¨CancelToken</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">cancellationChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">CancelToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†é€šè¿‡ChangeTokenç±»ä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„TestCancellationChangeTokenç±»ï¼ŒChangeTokençš„OnChangeæ–¹æ³•ä¼ é€’äº†åˆ›å»ºæ–°CancellationChangeTokenå®ä¾‹çš„æ–¹æ³•å§”æ‰˜ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯å–æ¶ˆä»¤ç‰Œçš„å›è°ƒæ“ä½œï¼Œè¿™æ ·ä¾¿å¯ä»¥é‡å¤çš„ä½¿ç”¨å–æ¶ˆæ“ä½œï¼Œä¸ºäº†æ¼”ç¤ºæ•ˆæœåœ¨å¾ªç¯é‡Œé‡å¤è°ƒç”¨CancelTokenæ–¹æ³•æ˜¾ç¤ºçš„æ‰“å°ç»“æœæ˜¯</p><p>16:40:15è¢«è§¦å‘å¯ä¸€æ¬¡ 16:40:16è¢«è§¦å‘å¯ä¸€æ¬¡ 16:40:17è¢«è§¦å‘å¯ä¸€æ¬¡ CancellationChangeTokenç±»æ˜¯é€šè¿‡ChangeTokenå®ç°é‡å¤å–æ¶ˆè§¦å‘è°ƒç”¨çš„ç®€å•å®ç°ï¼Œä¸¤è€…å°†ç»“åˆçš„æ—¶å€™éœ€è¦è‡ªå·±åŒ…è£…ä¸€ä¸‹ï¼Œå› ä¸ºChangeTokençš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦æ¯æ¬¡è·å–CancellationChangeTokenå®ä¾‹çš„å§”æ‰˜ï¼Œæ‰€ä»¥éœ€è¦å°†å®ƒåŒ…è£…åˆ°å·¥ä½œç±»ä¸­ã€‚</p><h3 id="compositechangetokenç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#compositechangetokenç¤ºä¾‹"><span>CompositeChangeTokenç¤ºä¾‹</span></a></h3><p>å®é™…å¼€å‘ä¸­å¾ˆå¤šæ—¶å€™éƒ½éœ€è¦ä¸€äº›å…³è”çš„åœºæ™¯ï¼Œæ¯”å¦‚æˆ‘è§¦å‘äº†ä¸€ä¸ªå–æ¶ˆæ“ä½œï¼Œæˆ‘æƒ³æŠŠå’Œè¿™ä¸ªç›¸å…³è”çš„å…¶å®ƒæ“ä½œä¹Ÿå–æ¶ˆï¼Œä¹Ÿå°±æ˜¯å’±ä»¬è¯´çš„æœ‰ç›¸å…³æ€§ã€‚CompositeChangeTokenæ­£æ˜¯å¯ä»¥ç»‘å®šä¸€ä¸ªç›¸å…³æ€§çš„IChangeTokené›†åˆï¼Œå½“è¿™ä¸ªIChangeTokené›†åˆä¸­æœ‰ä»»ä½•ä¸€ä¸ªå®ä¾‹è¿›è¡Œå–æ¶ˆæ“ä½œçš„æ—¶å€™ï¼Œå½“å‰CompositeChangeTokenå®ä¾‹ä¹Ÿä¼šæ‰§è¡Œå–æ¶ˆæ“ä½œï¼Œå’±ä»¬å°±å¤§è‡´æ¼”ç¤ºä¸€ä¸‹å®ƒçš„ä½¿ç”¨æ–¹å¼ï¼Œé¦–å…ˆæ˜¯å®šä¹‰ä¸€ä¸ªä½¿ç”¨ç±»TestCompositeChangeTokenæ¥æ¨¡æ‹ŸåŒ…è£…CompositeChangeTokenå®ä¾‹</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span></span></span>
<span class="line"><span>public class TestCompositeChangeToken</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    //å£°æ˜ä¸€ä¸ªCancellationTokenSourceé›†åˆ</span></span>
<span class="line"><span>    private List&lt;CancellationTokenSource&gt; _cancellationTokenSources;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// è·å–CompositeChangeTokenå®ä¾‹æ–¹æ³•</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public CompositeChangeToken CreatChanageToken()</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        //åˆå§‹åŒ–ä¸‰ä¸ªCancellationTokenSourceå®ä¾‹</span></span>
<span class="line"><span>        var firstCancellationTokenSource = new CancellationTokenSource();</span></span>
<span class="line"><span>        var secondCancellationTokenSource = new CancellationTokenSource();</span></span>
<span class="line"><span>        var threeCancellationTokenSource = new CancellationTokenSource();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        //åˆ†åˆ«æ³¨å†Œä¸€ä¸ªå›è°ƒæ“ä½œç”¨äºæ¼”ç¤º</span></span>
<span class="line"><span>        firstCancellationTokenSource.Token.Register(() =&gt; System.Console.WriteLine(&quot;firstCancellationTokenSourceè¢«å–æ¶ˆ&quot;));</span></span>
<span class="line"><span>        secondCancellationTokenSource.Token.Register(() =&gt; System.Console.WriteLine(&quot;secondCancellationTokenSourceè¢«å–æ¶ˆ&quot;));</span></span>
<span class="line"><span>        threeCancellationTokenSource.Token.Register(() =&gt; System.Console.WriteLine(&quot;threeCancellationTokenSourceè¢«å–æ¶ˆ&quot;));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        //åŠ å…¥åˆ°é›†åˆè¿˜</span></span>
<span class="line"><span>        _cancellationTokenSources = new List&lt;CancellationTokenSource&gt;</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            firstCancellationTokenSource,</span></span>
<span class="line"><span>            secondCancellationTokenSource,</span></span>
<span class="line"><span>            threeCancellationTokenSource</span></span>
<span class="line"><span>        };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        //ç”ŸæˆCancellationChangeTokené›†åˆ</span></span>
<span class="line"><span>        var cancellationChangeTokens = _cancellationTokenSources.Select(i =&gt; new CancellationChangeToken(i.Token)).ToList();</span></span>
<span class="line"><span>        //ä¼ é€’ç»™CompositeChangeToken</span></span>
<span class="line"><span>        var compositeChangeToken = new CompositeChangeToken(cancellationChangeTokens);</span></span>
<span class="line"><span>        //ç»™CompositeChangeTokenå®ä¾‹æ³¨å†Œä¸€ä¸ªå–æ¶ˆå›è°ƒæ–¹ä¾¿æ¼”ç¤º</span></span>
<span class="line"><span>        compositeChangeToken.RegisterChangeCallback(state =&gt; System.Console.WriteLine(&quot;compositeChangeTokenè¢«å–æ¶ˆ&quot;),null);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        return compositeChangeToken;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// å–æ¶ˆCancellationTokenSource</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public void CancelToken()</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        //æ–¹ä¾¿æ¼”ç¤ºæ•ˆæœåœ¨_cancellationTokenSourcesé›†åˆéšä¾¿è·å–ä¸€ä¸ªå–æ¶ˆ</span></span>
<span class="line"><span>        _cancellationTokenSources[new Random().Next(_cancellationTokenSources.Count)].Cancel();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œåœ¨è·å–CompositeChangeTokenå®ä¾‹çš„CreatChanageTokenæ–¹æ³•ä¸­åˆ›å»ºäº†ä¸‰ä¸ªCancellationTokenSourceå®ä¾‹ï¼Œç„¶åç”¨è¿™ä¸‰ä¸ªå®ä¾‹åˆå§‹åŒ–äº†ä¸€ä¸ªCancellationChangeTokené›†åˆï¼Œç”¨è¿™ä¸ªé›†åˆåˆå§‹åŒ–äº†ä¸€ä¸ªCompositeChangeTokenå®ä¾‹ï¼Œæ¥æ¨¡æ‹Ÿé›†åˆä¸­çš„CancellationChangeTokenå®ä¾‹å’ŒCompositeChangeTokenå®ä¾‹çš„ç›¸å…³æ€§ã€‚CancelTokenæ–¹æ³•ä¸­éšæœºè·å–äº†ä¸€ä¸ªCancellationTokenSourceå®ä¾‹è¿›è¡Œå–æ¶ˆæ“ä½œï¼Œæ¥æ›´å¥½çš„æ¼”ç¤ºç›¸å…³æ€§ã€‚å› ä¸ºCompositeChangeTokenç±»ä¹Ÿå®ç°äº†IChangeTokenæ¥å£ï¼Œæ‰€ä»¥ç”¨èµ·æ¥éƒ½ä¸€æ ·ï¼Œå¤§è‡´å¦‚ä¸‹</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//å£°æ˜ç±»çš„å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TestCompositeChangeToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> compositeChangeToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> TestCompositeChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> compositeChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">CreatChanageToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(), () </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Console</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">WriteLine</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">$&quot;{</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">DateTime</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Now</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">HH</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">mm</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">ss</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">}è¢«è§¦å‘å¯ä¸€æ¬¡&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">//æ¨¡æ‹Ÿå¤šæ¬¡è°ƒç”¨CancelToken</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    compositeChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">CancelToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†æ¼”ç¤ºå¯ä»¥é‡å¤è§¦å‘å–æ¶ˆæ“ä½œï¼Œè¿™é‡Œä¾ç„¶ä½¿ç”¨å¾ªç¯çš„æ–¹å¼æ¨¡æ‹Ÿå¤šæ¬¡è§¦å‘ã€‚å› ä¸ºå­˜åœ¨ç›¸å…³æ€§ï¼Œæ‰€ä»¥æ‰“å°çš„æ‰§è¡Œç»“æœå¦‚ä¸‹</p><p>12:05:18è¢«è§¦å‘å¯ä¸€æ¬¡ compositeChangeTokenè¢«å–æ¶ˆ secondCancellationTokenSourceè¢«å–æ¶ˆ</p><p>12:05:19è¢«è§¦å‘å¯ä¸€æ¬¡ compositeChangeTokenè¢«å–æ¶ˆ firstCancellationTokenSourceè¢«å–æ¶ˆ</p><p>12:05:20è¢«è§¦å‘å¯ä¸€æ¬¡ compositeChangeTokenè¢«å–æ¶ˆ secondCancellationTokenSourceè¢«å–æ¶ˆ ä»ç»“æœä¸Šå¯ä»¥çœ‹åˆ°ä»»ä½•ä¸€ä¸ªç›¸å…³è”CancellationChangeTokenå®ä¾‹çš„CancellationTokenSourceå®ä¾‹è¢«å–æ¶ˆçš„è¯ï¼Œä¸å…¶ç›¸å…³çš„CompositeChangeTokenå®ä¾‹ä¹Ÿæ‰§è¡Œäº†å–æ¶ˆæ“ä½œï¼Œåœ¨æœ‰äº›åœºæ™¯ä¸‹è¿˜æ˜¯æ¯”è¾ƒå®ç”¨çš„ã€‚</p><h2 id="æºç æ¢ç©¶" tabindex="-1"><a class="header-anchor" href="#æºç æ¢ç©¶"><span>æºç æ¢ç©¶</span></a></h2><p>ä¸Šé¢æˆ‘ä»¬é€šè¿‡ç®€å•çš„ç¤ºä¾‹å¤§è‡´äº†è§£äº†ChangeTokenæ˜¯åšå•¥çš„ï¼Œä»¥åŠå®ƒæ€ä¹ˆä½¿ç”¨ã€‚é€šè¿‡åå­—å¯ä»¥å¾—çŸ¥ï¼Œå®ƒå«æ›´æ”¹ä»¤ç‰Œï¼Œè¯´æ˜å¯ä»¥åŠ¨æ€äº§ç”Ÿä»¤ç‰Œçš„å€¼ã€‚å®ƒæ¶‰åŠåˆ°äº†å‡ ä¸ªæ ¸å¿ƒçš„æ“ä½œç›¸å…³åˆ†åˆ«æ˜¯IChangeTokenæ¥å£ã€CancellationChangeTokenã€CompositeChangeTokenå’ŒChangeTokené™æ€ç±»ï¼Œé€šè¿‡ä¸Šé¢å’±ä»¬çš„ç¤ºä¾‹å’Œè®²è§£æˆ‘ä»¬å¤§è‡´äº†è§£äº†è¿™å‡ ä¸ªç±»å‹çš„å…³ç³»ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»å’Œæ€ç»´å¸¦å…¥å’±ä»¬å°±æŒ‰ç…§æ–¹ä¾¿ç†è§£çš„é¡ºåºæ¥æŒ¨ä¸ªè®²è§£ã€‚ å‹æƒ…æç¤º:æœ¬æ–‡è®¾è®¡åˆ°ç²˜è´´å‡ºæ¥çš„ç›¸å…³æºç ï¼Œè¿™äº›æºç æ˜¯çœç•¥æ‰ä¸€éƒ¨åˆ†è¿‡ç¨‹çš„ã€‚å› ä¸ºæˆ‘ä»¬ä¸»è¦æ˜¯äº†è§£å®ƒçš„å®ç°ï¼Œæ— å…³ç´§è¦çš„ä»£ç å¯èƒ½ä¼šå½±å“é˜…è¯»æ•ˆæœã€‚è€Œä¸”è¿™æ¬¡çš„GitHubæºç åœ°å€æˆ‘æ›´æ¢ä¸ºhttps://hub.fastgit.orgè€Œæ²¡æœ‰ä½¿ç”¨å®˜æ–¹çš„https://github.comï¼Œä¸»è¦æ˜¯GitHubè¿‘æœŸå¾ˆä¸ç¨³å®šç»å¸¸æ‰“ä¸å¼€ã€‚fastgitæ˜¯githubçš„é•œåƒç½‘ç«™ï¼Œå±•ç¤ºçš„å†…å®¹æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæœ€ä¸»è¦çš„æ˜¯æ‰“å¼€å¾ˆæµç•…ã€‚</p><h3 id="ichangetokenæ¥å£" tabindex="-1"><a class="header-anchor" href="#ichangetokenæ¥å£"><span>IChangeTokenæ¥å£</span></a></h3><p>é¦–å…ˆä¾¿æ˜¯IChangeTokenæ¥å£ï¼Œå®ƒæ˜¯æ•´ä¸ªChangeTokenç³»åˆ—çš„å…¥å£æ“ä½œï¼ŒChangeTokençš„OnChangeæ“ä½œä¹Ÿæ˜¯é€šè¿‡å®ƒçš„å®ç°ç±»å‘èµ·çš„ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯è·å–ä¸€ä¸ªå¯ä»¥æ›´æ”¹çš„ä»¤ç‰Œï¼Œä¹Ÿå°±æ˜¯å¯ä»¥é‡å¤è§¦å‘çš„ä»¤ç‰Œï¼Œå’±ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[2]]</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public interface IChangeToken</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// ç”¨æ¥æ ‡è¯†æ˜¯å¦å‘ç”Ÿè¿‡æ›´æ”¹</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    bool HasChanged { get; }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// æŒ‡ç¤ºä»¤ç‰Œæ˜¯å¦æ”¯æŒå›è°ƒ</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    bool ActiveChangeCallbacks { get; }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// å½“ä»¤ç‰Œå–æ¶ˆæ—¶æ‰§è¡Œçš„å›è°ƒ</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    /// &lt;param name=&quot;callback&quot;&gt;å›è°ƒæ‰§è¡Œå§”æ‰˜&lt;/param&gt;</span></span>
<span class="line"><span>    /// &lt;param name=&quot;state&quot;&gt;å›è°ƒå§”æ‰˜çš„å‚æ•°&lt;/param&gt;</span></span>
<span class="line"><span>    /// &lt;returns&gt;An &lt;see cref=&quot;IDisposable&quot;/&gt; that is used to unregister the callback.&lt;/returns&gt;</span></span>
<span class="line"><span>    IDisposable RegisterChangeCallback(Action&lt;object&gt; callback, object state);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ƒå®šä¹‰çš„æ¥å£æˆå‘˜éå¸¸ç®€å•ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯åˆ¤æ–­æ˜¯å¦å‘ç”Ÿè¿‡æ›´æ”¹ç›¸å…³å³å–æ¶ˆæ“ä½œï¼Œä¸€ä¸ªæ˜¯å‘ç”Ÿè¿‡æ›´æ”¹ä¹‹åçš„å›è°ƒæ“ä½œã€‚å®ƒåªæ˜¯å®šä¹‰ä¸€ä¸ªæ ‡å‡†ä»»ä½•å®ç°è¿™ä¸ªæ ‡å‡†çš„ç±»éƒ½å…·å¤‡è¢«ChangeTokençš„OnChangeæ–¹æ³•æä¾›å¯æ›´æ¢ä»¤ç‰Œçš„èƒ½åŠ›ã€‚</p><h3 id="cancellationchangetokenå®ç°" tabindex="-1"><a class="header-anchor" href="#cancellationchangetokenå®ç°"><span>CancellationChangeTokenå®ç°</span></a></h3><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº†IChageTokenæ¥å£å®šä¹‰çš„æˆå‘˜ç›¸å…³ï¼Œè€ŒCancellationChangeTokenåˆ™æ˜¯IChageTokenæ¥å£æœ€å¸¸ä½¿ç”¨é»˜è®¤çš„å®ç°ï¼Œäº†è§£äº†å®ƒçš„å®ç°ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ›´å¥½çš„çŸ¥é“ChangeTokençš„OnChangeæ–¹æ³•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘é€‰æ‹©äº†å…ˆè®²è§£CancellationChangeTokenç›¸å…³çš„å®ç°ï¼Œè¿™æ ·ä¼šè®©æ¥ä¸‹æ¥çš„é˜…è¯»å˜å¾—æ›´å®¹æ˜“ç†è§£ã€‚å¥½äº†ç›´æ¥çœ‹å®ƒçš„å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[3]]</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span></span></span>
<span class="line"><span>public class CancellationChangeToken : IChangeToken</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// å”¯ä¸€æ„é€ å‡½æ•°é€šè¿‡CancellationChangeTokenåˆå§‹åŒ–</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public CancellationChangeToken(CancellationToken cancellationToken)</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        Token = cancellationToken;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// å› ä¸ºå®ƒæ˜¯é€šè¿‡CancellationTokenå®ç°å…·å¤‡å›è°ƒçš„èƒ½åŠ›</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public bool ActiveChangeCallbacks { get; private set; } = true;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// æ ¹æ®CancellationTokençš„IsCancellationRequestedå±æ€§åˆ¤æ–­ä»¤ç‰Œæ˜¯å¦å·²å–æ¶ˆ</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    public bool HasChanged =&gt; Token.IsCancellationRequested;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// æ¥æ”¶ä¼ é€’è¿›æ¥çš„CancellationToken</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    private CancellationToken Token { get; }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /// &lt;summary&gt;</span></span>
<span class="line"><span>    /// æ³¨å†Œå›è°ƒæ“ä½œ</span></span>
<span class="line"><span>    /// &lt;/summary&gt;</span></span>
<span class="line"><span>    /// &lt;returns&gt;&lt;/returns&gt;</span></span>
<span class="line"><span>    public IDisposable RegisterChangeCallback(Action&lt;object&gt; callback, object state)</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        try</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            //æœ¬è´¨è¿˜æ˜¯é€šè¿‡CancellationTokenå®Œæˆå®ƒå›è°ƒæ“ä½œçš„åŠŸèƒ½</span></span>
<span class="line"><span>            return Token.UnsafeRegister(callback, state);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        catch (ObjectDisposedException)</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            ActiveChangeCallbacks = false;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return NullDisposable.Instance;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private class NullDisposable : IDisposable</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        public static readonly NullDisposable Instance = new NullDisposable();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        public void Dispose()</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼ŒCancellationChangeTokençš„æœ¬è´¨è¿˜æ˜¯CancellationTokençš„åŒ…è£…ç±»ï¼Œå› ä¸ºæˆ‘ä»¬çœ‹åˆ°äº†CancellationChangeTokenç±»çš„æ ¸å¿ƒæ“ä½œå®ç°éƒ½æ˜¯ä¾èµ–çš„CancellationChangeTokenç±»çš„å®ç°å®Œæˆçš„ã€‚å®ƒçš„HasChangedå±æ€§å’ŒRegisterChangeCallbackæ–¹æ³•éƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„CancellationChangeTokenç±»çš„å®ç°ã€‚</p><h3 id="changetokenç±»çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#changetokenç±»çš„å®ç°"><span>ChangeTokenç±»çš„å®ç°</span></a></h3><p>ä¸Šé¢æˆ‘ä»¬è®²è§£äº†IChangeTokenæ¥å£çš„ç›¸å…³å®ç°ï¼Œä¹Ÿè¯´æ˜äº†å› ä¸ºChangeTokenç±»æ˜¯ä¾èµ–IChangeTokenæ¥å£å®ç°æ¥å®Œæˆçš„ï¼Œæ‰€ä»¥å’±ä»¬æ˜¯ä»IChangeTokenç±»å¼€å§‹è®²è§£çš„ã€‚äº†è§£äº†ä¸Šé¢çš„å®ç°ä¹‹åï¼Œå’±ä»¬å°±å¯ä»¥ç›´æ¥æ¥çœ‹ChangeTokenç›¸å…³çš„å®ç°äº†,è€Œæˆ‘ä»¬ä½¿ç”¨çš„å°±æ˜¯å®ƒçš„OnChangeæ–¹æ³•[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[4]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Func</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">changeTokenProducer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Action</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> changeTokenConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ChangeTokenRegistration</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">changeTokenProducer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> callback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(), </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">changeTokenConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Func</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">changeTokenProducer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">changeTokenConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TState</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ChangeTokenRegistration</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">changeTokenProducer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">changeTokenConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ƒçš„OnChangeæ–¹æ³•å…¶å®æ˜¯åŒ…å«ä¸¤ä¸ªé‡è½½çš„ï¼Œä¸€ä¸ªæ˜¯æ— å‚å§”æ‰˜ä¸€ä¸ªæ˜¯æœ‰å‚å§”æ‰˜ã€‚æ— å‚å§”æ‰˜æ²¡å•¥å¥½è¯´çš„ï¼Œé€šè¿‡æœ‰å‚å›è°ƒæˆ‘ä»¬å¯ä»¥ç»™å›è°ƒä¼ é€’å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯æ–¹æ³•ä¼ é€’æ¯æ¬¡å›è°ƒå§”æ‰˜è·å–çš„å€¼å–å†³äºStateæœ¬èº«çš„å€¼æ˜¯ä»€ä¹ˆã€‚æœ€é‡è¦çš„æ˜¯å®ƒä»¬ä¸¤ä¸ªéƒ½æ˜¯è¿”å›äº†ChangeTokenRegistrationç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´OnChangeæ–¹æ³•æœ¬èº«æ˜¯ä¸€ä¸ªå¤–è§‚ç”¨æ¥éšè—ChangeTokenRegistrationè¿™ä¸ªç±»çš„å…·ä½“ä¿¡æ¯ï¼Œå› ä¸ºChangeTokenRegistrationåªéœ€è¦åœ¨ChangeTokenå†…éƒ¨ä½¿ç”¨ã€‚é‚£æˆ‘ä»¬å°±ç›´æ¥çœ‹ä¸€ä¸‹ChangeTokenRegistrationå†…éƒ¨ç±»çš„å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[5]]</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span></span></span>
<span class="line"><span>private class ChangeTokenRegistration&lt;TState&gt; : IDisposable</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    //ç”Ÿäº§IChangeTokenå®ä¾‹çš„å§”æ‰˜</span></span>
<span class="line"><span>    private readonly Func&lt;IChangeToken&gt; _changeTokenProducer;</span></span>
<span class="line"><span>    //å›è°ƒå§”æ‰˜</span></span>
<span class="line"><span>    private readonly Action&lt;TState&gt; _changeTokenConsumer;</span></span>
<span class="line"><span>    //å›è°ƒå‚æ•°</span></span>
<span class="line"><span>    private readonly TState _state;</span></span>
<span class="line"><span>    public ChangeTokenRegistration(Func&lt;IChangeToken&gt; changeTokenProducer, Action&lt;TState&gt; changeTokenConsumer, TState state)</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        _changeTokenProducer = changeTokenProducer;</span></span>
<span class="line"><span>        _changeTokenConsumer = changeTokenConsumer;</span></span>
<span class="line"><span>        _state = state;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        //æ‰§è¡ŒchangeTokenProducerå¾—åˆ°IChangeTokenå®ä¾‹</span></span>
<span class="line"><span>        IChangeToken token = changeTokenProducer();</span></span>
<span class="line"><span>        //è°ƒç”¨RegisterChangeTokenCallbackæ–¹æ³•ä¼ é€’IChangeTokenå®ä¾‹</span></span>
<span class="line"><span>        RegisterChangeTokenCallback(token);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°ChangeTokenRegistrationæ­£æ˜¯å®ç°ChangeTokenæ•ˆæœçš„æ ¸å¿ƒï¼Œè€Œå®ƒçš„æ„é€ å‡½æ•°é‡Œé€šè¿‡æ‰§è¡Œä¼ é€’è¿›æ¥äº§ç”ŸIChangeTokenæ–°å®ä¾‹çš„å§”æ‰˜å¾—åˆ°äº†æ–°çš„IChangeTokenå®ä¾‹ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ¯æ¬¡æ‰§è¡ŒFuncéƒ½ä¼šå¾—åˆ°æ–°çš„IChangeTokenå®ä¾‹ã€‚ç„¶åè°ƒç”¨äº†RegisterChangeTokenCallbackæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•åªéœ€è¦ä¼ é€’å¾—åˆ°çš„IChangeTokenå®ä¾‹å³å¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦çœ‹RegisterChangeTokenCallbackæ–¹æ³•å®ç°å³å¯[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[6]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> RegisterChangeTokenCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //ç»™IChangeTokenå®ä¾‹æ³¨å†Œå›è°ƒæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //å›è°ƒæ“ä½œæ­£æ˜¯æ‰§è¡Œå½“å‰ChangeTokenRegistrationå®ä¾‹çš„OnChangeTokenFiredæ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> registraton</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">RegisterChangeCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">s</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> ((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">ChangeTokenRegistration</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">TState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;)</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">OnChangeTokenFired</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    SetDisposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">registraton</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºChangeTokenRegistrationçš„RegisterChangeTokenCallbackæ–¹æ³•æœ¬è´¨è¿˜æ˜¯ä½¿ç”¨äº†IChangeTokenå®ä¾‹çš„RegisterChangeCallbackæ–¹æ³•æ¥å®ç°çš„ï¼Œä¸è¿‡è¿™é‡Œçš„å›è°ƒæ‰§è¡Œçš„æ˜¯å½“å‰ChangeTokenRegistrationå®ä¾‹çš„OnChangeTokenFiredæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ä»¤ç‰Œå–æ¶ˆçš„æ—¶å€™è°ƒç”¨çš„å°±æ˜¯OnChangeTokenFiredæ–¹æ³•ï¼Œå’±ä»¬ç›´æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[7]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> OnChangeTokenFired</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //è·å–ä¸€ä¸ªæ–°çš„IChangeTokenå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    IChangeToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> _changeTokenProducer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    try</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //æ‰§è¡Œæ³¨å†Œçš„å›è°ƒæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        _changeTokenConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    finally</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //åˆè°ƒç”¨äº†RegisterChangeTokenCallbackæ³¨å†Œå½“å‰IChangeTokenå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        RegisterChangeTokenCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹ä¸Šé¢çš„ä»£ç æˆ‘ç¬¬ä¸€ååº”å°±æ˜¯è±ç„¶å¼€æœ—ï¼Œé€šè¿‡OnChangeTokenFiredæ–¹æ³•çš„å®ç°ä»¿ä½›ä¸€åˆ‡éƒ½é€å½»äº†ã€‚é¦–å…ˆè°ƒç”¨_changeTokenProducerå§”æ‰˜è·å–æ–°çš„IChangeTokenå®ä¾‹ï¼Œå³æˆ‘ä»¬é€šè¿‡å³æˆ‘ä»¬é€šè¿‡ChangeTokençš„OnChangeæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’çš„å§”æ‰˜ã€‚ç„¶åæ‰§è¡Œ_changeTokenConsumerå§”æ‰˜ï¼Œå³æˆ‘ä»¬é€šè¿‡ChangeTokençš„OnChangeæ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’çš„å§”æ‰˜ã€‚æœ€åä¼ é€’å½“å‰é€šè¿‡_changeTokenProducerå§”æ‰˜äº§ç”Ÿçš„æ–°IChangeTokenå®ä¾‹è°ƒç”¨RegisterChangeTokenCallbackæ–¹æ³•ï¼Œå³å’±ä»¬ä¸Šé¢çš„é‚£ä¸ªæ–¹æ³•ï¼Œè¿™æ ·å°±å®Œæˆäº†ç±»ä¼¼ä¸€ä¸ªé€’å½’çš„æ“ä½œã€‚æ‰§è¡Œå®Œä¹‹ååˆå°†è¿™å¥—æµç¨‹é‡æ–°æ³¨å†Œäº†ä¸€éï¼Œç„¶åå½¢æˆäº†è¿™ç§å¯ä»¥æŒç»­è§¦å‘çš„æ“ä½œã€‚ä¸Šé¢çš„RegisterChangeTokenCallbackæ–¹æ³•é‡Œé‡Œè°ƒç”¨äº†SetDisposableæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯åˆ¤æ–­Tokenæœ‰æ²¡æœ‰è¢«å–æ¶ˆã€‚å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨IChangeTokenå®ä¾‹çš„æ—¶å€™ä¼šæ¶‰åŠåˆ°å¤šçº¿ç¨‹å…±äº«çš„é—®é¢˜ï¼Œè€ŒIChangeTokenå®ä¾‹æœ¬èº«è®¾è®¡è€ƒè™‘åˆ°äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´çœ‹ä¸‹SetDisposableçš„å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[8]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> readonly</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> NoopDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _disposedSentinel</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> NoopDisposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> SetDisposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //è¯»å–_disposableå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> current</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> Volatile</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Read</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //å¦‚æœå½“å‰_disposableå®ä¾‹ç­‰äº_disposedSentinelå®ä¾‹åˆ™è¯´æ˜å½“å‰ChangeTokenRegistrationå·²è¢«é‡Šæ”¾ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //åˆ™ç›´æ¥é‡Šæ”¾IChangeTokenå®ä¾‹ç„¶åè¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">current</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _disposedSentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">        disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //çº¿ç¨‹å®‰å…¨äº¤æ¢ï¼Œå¦‚æœä¹‹å‰_disposableçš„å€¼ç­‰äº_disposedSentinelè¯´æ˜è¢«é‡Šæ”¾è¿‡äº†</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //åˆ™é‡Šæ”¾IChangeTokenå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> previous</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> Interlocked</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">CompareExchange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">current</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">previous</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _disposedSentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">        disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //è¯´æ˜æ²¡æœ‰è¢«é‡Šæ”¾è¿‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    else</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">previous</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> current</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //è¯´æ˜åˆ«çš„çº¿ç¨‹æ“ä½œäº†disposeåˆ™ç›´æ¥å¼‚å¸¸</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> InvalidOperationException</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;Somebody else set the _disposable field&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸ºChangeTokenRegistrationæ˜¯å®ç°äº†IDisposableæ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸‹Disposeæ–¹æ³•çš„å®ç°ï¼Œè¿™æ ·çš„è¯ä¼šè®©å¤§å®¶æ›´å¥½çš„ç†è§£å®ƒçš„è¿™ä¸ªé‡Šæ”¾ä½“ç³»[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[9]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //å› ä¸º_disposableåˆå§‹å€¼æ˜¯nullæ‰€ä»¥æŠŠNoopDisposableå®ä¾‹èµ‹å€¼ç»™_disposableå¹¶è°ƒç”¨Disposeæ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    Interlocked</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Exchange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_disposedSentinel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸ºåˆå§‹å£°æ˜_disposableå˜é‡çš„æ—¶å€™åˆå§‹å€¼æ˜¯null,è¿™é‡ŒæŠŠNoopDisposableå®ä¾‹èµ‹å€¼ç»™_disposableå¹¶è°ƒç”¨Disposeæ–¹æ³•ã€‚å…¶å®Disposeæ–¹æ³•å•¥ä¹Ÿæ²¡åšå°±æ˜¯ä¸ºäº†æ ‡è®°ä¸€ä¸‹ï¼Œå› ä¸ºChangeTokenRegistrationç±»å¹¶æœªæ¶‰åŠåˆ°éæ‰˜ç®¡èµ„æºç›¸å…³çš„æ“ä½œã€‚</p><blockquote><p>é€šè¿‡SetDisposableæ–¹æ³•ç»“åˆDisposeæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£åœ¨è§¦å›è°ƒæ“ä½œçš„æ—¶å€™ä¼šè°ƒSetDisposableæ–¹æ³•è¿›è¡Œåˆ¤æ–­ChangeTokenRegistrationæœ‰æ²¡æœ‰è¢«é‡Šæ”¾è¿‡ï¼Œå¦‚æœå·²ç»è¢«é‡Šæ”¾åˆ™ç›´æ¥é‡Šæ”¾æ‰ä¼ é€’çš„IChangTokenå®ä¾‹ã€‚å› ä¸ºChangeTokençš„OnChangeæ–¹æ³•è¿”å›çš„å°±æ˜¯ChangeTokenRegistrationå®ä¾‹ï¼Œå¦‚æœè¿™ä¸ªè¢«é‡Šæ”¾åˆ™æ„å‘³äº†OnChangeä¼ é€’çš„IChangeTokenå®ä¾‹ä¹Ÿå¿…é¡»è¦é‡Šæ”¾ã€‚</p></blockquote><p>é€šè¿‡ä¸Šé¢è®²è§£äº†ChangeTokenRegistrationç±»çš„å®ç°æˆ‘ä»¬äº†è§£åˆ°äº†ChangeTokenç±»å·¥ä½œçš„æœ¬è´¨ï¼Œå…¶å®éå¸¸ç®€å•ï¼Œä¸ºäº†æ€•å¤§å®¶æ²¡çœ‹æ˜ç™½åœ¨è¿™é‡Œå’±ä»¬ç®€å•çš„æ€»ç»“ä¸€ä¸‹ChangeTokençš„æ•´ä½“å·¥ä½œè¿‡ç¨‹ã€‚</p><p>â€¢ChangeTokené™æ€ç±»åªåŒ…è£…äº†OnChangeæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼ é€’çš„æ ¸å¿ƒå‚æ•°æ˜¯äº§ç”ŸIChangeTokenå®ä¾‹çš„å§”æ‰˜å’ŒCancellationTokenSourceå®ä¾‹å–æ¶ˆåçš„å›è°ƒæ“ä½œã€‚è¿™é‡Œçš„IChangeTokenå®ä¾‹å’ŒChangeTokené™æ€ç±»æ²¡å•¥å…³ç³»ï¼Œå°±æ˜¯åå­—é•¿å¾—åƒã€‚ â€¢ChangeTokené™æ€ç±»çš„OnChangeæ–¹æ³•æœ¬è´¨æ˜¯åŒ…è£…ä¸€ä¸ªChangeTokenRegistrationå®ä¾‹ã€‚ChangeTokenRegistrationæ˜¯ChangeTokenç±»å·¥ä½œçš„æ ¸å¿ƒï¼Œå®ƒçš„å·¥ä½œæ–¹å¼æ˜¯ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ç”ŸæˆIChangeTokenå®ä¾‹ç„¶åè°ƒç”¨RegisterChangeTokenCallbackæ–¹æ³•ï¼Œåœ¨RegisterChangeTokenCallbackæ–¹æ³•æ–¹æ³•ä¸­ç»™IChangeTokenå®ä¾‹çš„RegisterChangeCallbackæ–¹æ³•æ³¨å†Œäº†å›è°ƒæ“ä½œã€‚ â€¢RegisterChangeCallbackå›è°ƒæ“ä½œæ³¨å†Œä¸€ä¸ªè°ƒç”¨OnChangeTokenFiredæ–¹æ³•çš„æ“ä½œï¼Œé€šè¿‡ä¸Šé¢çš„æºç æˆ‘ä»¬çŸ¥é“RegisterChangeCallbackæœ¬è´¨æ˜¯ç»™CancellationTokenæ³¨å†Œå›è°ƒï¼Œæ‰€ä»¥å½“CancellationTokenSourceè°ƒç”¨Cancelçš„æ—¶å€™å›æ‰§è¡ŒOnChangeTokenFiredæ–¹æ³•ã€‚ â€¢OnChangeTokenFiredæ–¹æ³•æ˜¯æ ¸å¿ƒæ“ä½œï¼Œå®ƒé¦–å…ˆæ˜¯è·å–ä¸€ä¸ªæ–°çš„IChangeTokenå®ä¾‹ï¼Œç„¶åæ‰§è¡Œæ³¨å†Œçš„å›è°ƒæ“ä½œã€‚ç„¶ååˆè°ƒç”¨äº†RegisterChangeTokenCallbackä¼ é€’äº†æœ€æ–°è·å–çš„IChangeTokenå®ä¾‹ï¼Œè¿™æ ·çš„è¯å°±å½¢æˆäº†ä¸€ä¸ªç±»ä¼¼é€’å½’çš„æ“ä½œï¼Œè€Œè¿™ä¸ªé€’å½’çš„ç»ˆæ­¢æ¡ä»¶å°±æ˜¯ChangeTokenRegistrationæœ‰æ²¡æœ‰è¢«é‡Šæ”¾ã€‚æ‰€ä»¥æ‰èƒ½å®ç°åŠ¨æ€æ›´æ”¹ä»¤ç‰Œçš„æ•ˆæœã€‚ ä¸€å¥è¯æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼ŒRegisterChangeCallbackä¸­ç»™CancellationChangeTokençš„å›è°ƒæ³¨å†Œäº†è°ƒç”¨OnChangeTokenFiredæ–¹æ³•çš„æ“ä½œï¼ŒOnChangeTokenFiredæ–¹æ³•ä¸­æœ‰è°ƒç”¨äº†RegisterChangeCallbackæ–¹æ³•ç»™å®ƒä¼ é€’äº†ç”Ÿæˆçš„IChangeTokenå®ä¾‹ï¼Œè€Œå›è°ƒæ“ä½œéƒ½æ˜¯åŒä¸€ä¸ªï¼Œåªæ˜¯ä¸æ–­è¢«æ–°çš„IChangeTokenå®ä¾‹è°ƒç”¨ã€‚</p><h3 id="compositechangetokenå®ç°" tabindex="-1"><a class="header-anchor" href="#compositechangetokenå®ç°"><span>CompositeChangeTokenå®ç°</span></a></h3><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ä¹‹æ‰€ä»¥æœ€åæ¥è¯´CompositeChangeTokençš„å®ç°ï¼Œå®Œå…¨æ˜¯å› ä¸ºå®ƒå±äºå¢å¼ºçš„æ“ä½œã€‚å¦‚æœå¤§å®¶ç†è§£äº†ç®€å•çš„å·¥ä½œæ–¹å¼çš„æµç¨‹ï¼Œç„¶åå†å»å°è¯•äº†è§£å¤æ‚çš„æ“ä½œå¯èƒ½ä¼šæ›´å®¹æ˜“ç†è§£ã€‚æ‰€ä»¥å’±ä»¬å…ˆè¯´äº†CancellationChangeTokenè¿™ä¸ªIChangeTokenæœ€ç®€å•çš„å®ç°ï¼Œç„¶åè¯´äº†ChangeTokené™æ€ç±»ï¼Œè®©å¤§å®¶å¯¹æ•´ä½“çš„å·¥ä½œæœºåˆ¶æœ‰äº†è§£ï¼Œæœ€åå’±ä»¬å†æ¥è®²è§£CompositeChangeTokenï¼Œè¿™æ ·çš„è¯å¤§å®¶ä¼šå¾ˆå®¹æ˜“å°±ç†è§£è¿™ä¸ªæ“ä½œæ–¹å¼çš„ã€‚å’±ä»¬è¿˜æ˜¯å…ˆä»å…¥å£çš„æ„é€ å‡½æ•°å…¥æ‰‹å§[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[10]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> CompositeChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IReadOnlyList</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;">ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> ActiveChangeCallbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">      public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> CompositeChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IReadOnlyList</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">changeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">          ChangeTokens</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> changeTokens</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> ??</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ArgumentNullException</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">nameof</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">changeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">          //éå†ä¼ å…¥çš„IChangeTokené›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">          for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Count</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">          {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">              /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">               * å¦‚æœé›†åˆä¸­å­˜åœ¨ä»»ä½•ä¸€ä¸ªIChangeTokenå®ä¾‹ActiveChangeCallbacksä¸ºtrue</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">               * åˆ™CompositeChangeTokençš„ActiveChangeCallbacksä¹Ÿä¸ºtrue</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">               * å› ä¸ºCompositeChangeTokenå¯ä»¥å…³è”IChangeTokené›†åˆä¸­çš„ä»»ä½•ä¸€ä¸ªæœ‰æ•ˆå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">               */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">              if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ActiveChangeCallbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">              {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">                  ActiveChangeCallbacks</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">                  break</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">              }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºIChangeTokené›†åˆä¸­å­˜åœ¨å¯ç”¨çš„å®ä¾‹å³å¯ï¼Œå› ä¸ºCompositeChangeTokenåªéœ€è¦çŸ¥é“é›†åˆä¸­å­˜åœ¨å¯ç”¨çš„å³å¯ï¼Œè€Œä¸æ˜¯è¦æ±‚å…¨éƒ¨çš„IChangeTokenéƒ½å¯ä»¥ç”¨ã€‚é€šè¿‡ChangeTokené™æ€ç±»çš„æºç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒCancellationTokenSourceçš„Cancelæ–¹æ³•æ‰§è¡Œåè°ƒç”¨çš„æ˜¯IChangeTokençš„RegisterChangeCallbackæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å›è°ƒè§¦å‘çš„æ“ä½œå°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[11]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> CancellationTokenSource</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _cancellationTokenSource</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> RegisterChangeCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">object</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //æ ¸å¿ƒæ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    EnsureCallbacksInitialized</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">   //è¿™é‡Œçš„CancellationTokenSourceæ³¨å†ŒCompositeChangeTokençš„å›è°ƒæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> _cancellationTokenSource</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Register</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> readonly</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;">_onChangeDelegate</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _registeredCallbackProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IDisposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;">_disposables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> readonly</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> object</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _callbackLock</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> object</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> EnsureCallbacksInitialized</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">   //åˆ¤æ–­æ˜¯å¦å·²ä½¿ç”¨RegisterChangeCallbackæ³¨å†Œè¿‡å›è°ƒæ“ä½œï¼Œå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ™ç›´æ¥è¿”å›</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_registeredCallbackProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">   //åŠ é” æ„å‘³ç€è¿™ä¸ªæ“ä½œè¦çº¿ç¨‹å®‰å…¨</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_callbackLock</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_registeredCallbackProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //å®ä¾‹åŒ–CancellationTokenSourceï¼Œå› ä¸ºRegisterChangeCallbackæ–¹æ³•é‡Œå†ç”¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">        _cancellationTokenSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> CancellationTokenSource</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">        _disposables</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> List</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IDisposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //å¾ªç¯è¦å…³è”çš„IChangeTokené›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Count</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">            //åˆ¤æ–­æ³¨å†Œè¿›æ¥çš„IChangeTokenå®ä¾‹æ˜¯å¦æ”¯æŒå›è°ƒæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ActiveChangeCallbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">                //ç»™IChangeTokenå®ä¾‹æ³¨å†Œå›è°ƒæ“ä½œæ‰§è¡Œ_onChangeDelegateå§”æ‰˜</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">                IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> disposable</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">RegisterChangeCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_onChangeDelegate</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">                //è¿”å›å€¼åŠ å…¥IDisposableé›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">                _disposables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">disposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">       //æ ‡è¯†æ³¨å†Œè¿‡äº†ï¼Œé˜²æ­¢é‡å¤æ³¨å†Œå¼•å‘çš„å¤šæ¬¡è§¦å‘</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">        _registeredCallbackProxy</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç æˆ‘ä»¬çœ‹åˆ°äº†æ ¸å¿ƒçš„å…³è”å›è°ƒæ“ä½œæ˜¯æ‰§è¡Œäº†_onChangeDelegateå§”æ‰˜ï¼Œå®ƒæ˜¯è¢«OnChangeæ–¹æ³•åˆå§‹åŒ–çš„ã€‚è¿™ä¸€æ­¥æ“ä½œå…¶å®å°±æ˜¯æŠŠå…³è”çš„IChangeTokenå®ä¾‹æ³¨å†Œ_onChangeDelegateå§”æ‰˜æ“ä½œï¼Œå’±ä»¬æ¥çœ‹ä¸‹CompositeChangeTokençš„OnChangeæ–¹æ³•å®ç°[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[12]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">object</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //è·å–ä¼ é€’çš„CompositeChangeTokenå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    var</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> compositeChangeTokenState</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">CompositeChangeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //åˆ¤æ–­CancellationTokenSourceæ˜¯å¦è¢«åˆå§‹åŒ–è¿‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">compositeChangeTokenState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">_cancellationTokenSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //åŠ é” è¯´æ˜è¿™ä¸€æ­¥æ˜¯çº¿ç¨‹å®‰å…¨æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">compositeChangeTokenState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">_callbackLock</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        try</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">            /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">             * å–æ¶ˆå½“å‰å®ä¾‹çš„CancellationTokenSource</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">             * è¿™æ ·æ‰èƒ½æ‰§è¡ŒCompositeChangeTokenæ³¨å†Œçš„å›è°ƒæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">             */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">            compositeChangeTokenState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">_cancellationTokenSource</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        catch</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //è·å–EnsureCallbacksInitializedæ–¹æ³•ä¸­æ³¨å†Œçš„é›†åˆ,å³IChangeTokené›†åˆçš„å›è°ƒè¿”å›å€¼é›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    List</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IDisposable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;">disposables</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> compositeChangeTokenState</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">_disposables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //ä¸ä¸ºnullåˆ™é€šè¿‡å¾ªç¯çš„æ–¹å¼æŒ¨ä¸ªé‡Šæ”¾æ‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    Debug</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Assert</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">disposables</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> disposables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Count</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">        disposables</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„OnChangeæ–¹æ³•æˆ‘ä»¬å¾—çŸ¥ï¼Œå®ƒä¸»è¦æ˜¯å®ç°äº†åœ¨æ³¨å†Œè¿›æ¥çš„ä»»æ„IChangeTokenå®ä¾‹å¦‚æœå‘ç”Ÿäº†å–æ¶ˆæ“ä½œåˆ™å½“å‰çš„CompositeChangeTokenå®ä¾‹RegisterChangeCallbackè¿›æ¥çš„å›è°ƒæ“ä½œä¹Ÿè¦æ‰§è¡Œï¼Œè€Œä¸”è¿™ä¸€æ­¥è¦é‡Šæ”¾æ‰æ‰€æœ‰æ³¨å†ŒIChangeTokenå®ä¾‹ï¼Œå› ä¸ºåªè¦æœ‰ä¸€ä¸ªIChangeTokenå®ä¾‹æ‰§è¡Œäº†å–æ¶ˆæ“ä½œï¼Œåˆ™CompositeChangeTokenå®ä¾‹å’Œå…¶å®ƒæ³¨å†Œè¿›æ¥ç›¸å…³è”çš„IChangeTokenå®ä¾‹éƒ½è¦å–æ¶ˆã€‚IChangeTokenè¿˜æœ‰ä¸€ä¸ªHasChangeå±æ€§æ¥æ ‡è¯†å½“å‰IChangeTokenæ˜¯å¦è¢«å–æ¶ˆï¼Œå’±ä»¬æ¥çœ‹ä¸‹CompositeChangeTokenæ˜¯å¦‚ä½•å®ç°è¿™ä¸ªå±æ€§çš„[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[13]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> HasChanged</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    get</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //å¦‚æœå½“å‰å®ä¾‹çš„CancellationTokenSourceè¢«å–æ¶ˆè¿‡åˆ™è¯´æ˜å½“å‰CompositeChangeTokenå·²è¢«å–æ¶ˆ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">_cancellationTokenSource</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> _cancellationTokenSource</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">IsCancellationRequested</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //å¾ªç¯æ³¨å†Œè¿›æ¥çš„å…³è”çš„IChangeTokené›†åˆ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Count</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">            //å¦‚æœå­˜åœ¨å…³è”çš„IChangeTokenå®ä¾‹æœ‰è¢«å–æ¶ˆçš„é‚£ä¹ˆä¹Ÿè®¤ä¸ºå½“å‰CompositeChangeTokenå·²è¢«å–æ¶ˆ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ChangeTokens</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">HasChanged</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">                //è°ƒç”¨OnChangeæ˜¯å¦å…³è”çš„IChangeTokenå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">                OnChange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        //å¦åˆ™åˆ™æ²¡è¢«å–æ¶ˆè¿‡</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°HasChangedå±æ€§çš„è®¾è®¡æ€è·¯ç¬¦åˆå®ƒæ•´ä½“çš„è®¾è®¡æ€è·¯ã€‚åˆ¤æ–­æ˜¯å¦å–æ¶ˆçš„æ ‡è¯†æœ‰ä¸¤ä¸ªï¼Œå¦‚æœå½“å‰å®ä¾‹çš„CancellationTokenSourceè¢«å–æ¶ˆè¿‡åˆ™è¯´æ˜å½“å‰CompositeChangeTokenå·²è¢«å–æ¶ˆï¼Œè¿˜æœ‰å°±æ˜¯å¦‚æœå­˜åœ¨å…³è”çš„IChangeTokenå®ä¾‹æœ‰è¢«å–æ¶ˆçš„é‚£ä¹ˆä¹Ÿè®¤ä¸ºå½“å‰CompositeChangeTokenä¹Ÿè¢«å–æ¶ˆã€‚å¥½äº†é€šè¿‡ä¸Šé¢è¿™ä¸€éƒ¨åˆ†æ•´ä½“çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸€ä¸‹CompositeChangeTokençš„æ•´ä½“å®ç°æ€è·¯ã€‚</p><p>â€¢CompositeChangeTokençš„å–æ¶ˆå›è°ƒæ“ä½œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åŸºäºä¼ é€’çš„IChangeTokené›†åˆä¸­æ¿€æ´»æ›´æ”¹å›è°ƒå³ActiveChangeCallbacksä¸ºtrueçš„å®ä¾‹ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯å®ƒè‡ªèº«ç»´æŠ¤é€šè¿‡RegisterChangeCallbackæ³¨å†Œè¿›æ¥çš„å§”æ‰˜ï¼Œè¿™ä¸ªå§”æ‰˜æ˜¯å®ƒå†…éƒ¨ç»´æŠ¤çš„CancellationTokenSourceå®ç°çš„ã€‚ â€¢å› ä¸ºCompositeChangeTokençš„RegisterChangeCallbackæ–¹æ³•ä¸­ç»™æ³¨å†Œè¿›æ¥çš„IChangeTokené›†åˆä¸­çš„æ¯ä¸€ä¸ªActiveChangeCallbacksçš„å®ä¾‹æ³¨å†Œäº†å–æ¶ˆå›è°ƒæ“ä½œï¼Œæ‰€ä»¥å½“ChangeTokené™æ€ç±»è§¦å‘RegisterChangeCallbackå›è°ƒæ“ä½œçš„æ—¶å€™å›è°ƒç”¨CompositeChangeTokençš„OnChangeæ–¹æ³•ã€‚ â€¢CompositeChangeTokençš„OnChangeæ–¹æ³•ä¸­ä¼šå–æ¶ˆCompositeChangeTokenå†…éƒ¨ç»´æŠ¤çš„CancellationTokenSourceï¼Œä¹Ÿå°±æ˜¯è§¦å‘CompositeChangeTokenç±»æœ¬èº«çš„å›è°ƒï¼Œå¹¶ä¸”é‡Šæ”¾æ³¨å†Œè¿›æ¥çš„å…¶ä»–ç›¸å…³è”çš„IChangeTokenå®ä¾‹ï¼Œä»è€Œå®ç°äº†å…³è”å–æ¶ˆçš„æ“ä½œã€‚</p><blockquote><p>é€šè¿‡æºç æ¢ç©¶éƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆ†åˆ«å±•ç¤ºäº†å…³äºIChangeTokenæ¥å£ï¼Œä»¥åŠå®ƒæœ€ç®€å•çš„å®ç°ç±»CancellationChangeTokenç±»çš„å®ç°ï¼Œç„¶åæ ¹æ®CancellationChangeTokenç±»çš„å®ç°è®²è§£äº†ChangeTokené™æ€ç±»æ˜¯å¦‚ä½•å®ç°åŠ¨æ€ä»¤ç‰Œæ›´æ”¹çš„ï¼Œæœ€ååˆæ¢ç©¶äº†IChangeTokenæ¥å£çš„å¦ä¸€ä¸ªé«˜çº§çš„å¯ä»¥å…³è”æ›´æ”¹ä»¤ç‰Œæ“ä½œçš„CompositeChangeTokençš„ç”¨æ³•ï¼Œé€šè¿‡è¿™æ ·ä¸€ä¸ªæµç¨‹ï¼Œåšä¸»æœ¬äººè®¤ä¸ºæ˜¯æ›´å®¹æ˜“ç†è§£çš„ã€‚</p></blockquote><h2 id="è‡ªå®šä¹‰ichangetokenå®ç°" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰ichangetokenå®ç°"><span>è‡ªå®šä¹‰IChangeTokenå®ç°</span></a></h2><p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†CancellationChangeTokençš„ä½¿ç”¨æ–¹å¼éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€å®šçš„é™åˆ¶ï¼Œé‚£å°±æ˜¯éœ€è¦å¤–éƒ¨ä¼ é€’CancellationTokenSourceçš„å®ä¾‹ã€‚å…¶å®å¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªéœ€è¦çŸ¥é“ä½ æ˜¯IChangeTokenå®ä¾‹å°±å¥½äº†èƒ½æ»¡è¶³è¢«ChangeTokené™æ€ç±»ä½¿ç”¨å°±å¥½äº†ï¼Œè‡³äºä¼ é€’CancellationTokenSourceå•¥çš„ä¸éœ€è¦å¤–éƒ¨å…³å¿ƒï¼Œèƒ½ç›¸åº”çš„æ“ä½œå°±è¡Œäº†ï¼Œæ¯”å¦‚åœ¨.Net Coreçš„Configurationä½“ç³»ä¸­çš„ConfigurationReloadTokenï¼Œå®ƒæ˜¯ç”¨æ¥å®ç°é…ç½®å‘ç”Ÿå˜åŒ–é€šçŸ¥ConfigurationProvideré‡æ–°åŠ è½½æ•°æ®å®Œæˆè‡ªåŠ¨åˆ·æ–°æ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°æ–¹å¼[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[14]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ConfigurationReloadToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">IChangeToken</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //å†…éƒ¨å®šä¹‰äº†CancellationTokenSourceå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> CancellationTokenSource</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _cts</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> CancellationTokenSource</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> ActiveChangeCallbacks</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#ABB2BF;"> HasChanged</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> _cts</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">IsCancellationRequested</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /// </span><span style="--shiki-light:#6A737D;--shiki-dark:#ABB2BF;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">summary</span><span style="--shiki-light:#6A737D;--shiki-dark:#ABB2BF;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /// ç»™å½“å‰çš„CancellationTokenSourceå®ä¾‹æ³¨å†Œæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IDisposable</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> RegisterChangeCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">object</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> _cts</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Token</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Register</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">callback</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">state</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /// </span><span style="--shiki-light:#6A737D;--shiki-dark:#ABB2BF;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">summary</span><span style="--shiki-light:#6A737D;--shiki-dark:#ABB2BF;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /// æ·»åŠ OnReloadæ–¹æ³•,ä¾›å¤–éƒ¨å–æ¶ˆä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /// </span><span style="--shiki-light:#6A737D;--shiki-dark:#ABB2BF;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">summary</span><span style="--shiki-light:#6A737D;--shiki-dark:#ABB2BF;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> OnReload</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> _cts</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ƒåœ¨ConfigurationReloadTokenç±»çš„å†…éƒ¨å£°æ˜äº†CancellationTokenSourceç±»å‹çš„å±æ€§ï¼Œç„¶åæä¾›äº†å¯ä»¥å–æ¶ˆCancellationTokenSourceå®ä¾‹çš„æ–¹æ³•OnReloadï¼Œè¿™æ ·çš„è¯é€»è¾‘å¯ä»¥åœ¨å†…éƒ¨æ¶ˆåŒ–ï¼Œè€Œä¸åƒåœ¨å¤–éƒ¨ä¼ é€’ã€‚å½“é‡æ–°è·å–å®ƒçš„å®ä¾‹çš„æ—¶å€™é¢å¤–æä¾›ä¸€ä¸ªå¯è·å–ConfigurationReloadTokenæ–°å®ä¾‹çš„æ–¹æ³•å³å¯[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ[15]]</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ConfigurationReloadToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> _changeToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ConfigurationReloadToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> RaiseChanged</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //ç›´æ¥äº¤æ¢ä¸€ä¸ªæ–°çš„ConfigurationReloadTokenå®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">    ConfigurationReloadToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E06C75;"> previousToken</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> Interlocked</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Exchange</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _changeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ConfigurationReloadToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    //å–æ¶ˆä¸Šä¸€ä¸ªConfigurationReloadTokenå®ä¾‹å®ç°æ›´æ”¹é€šçŸ¥æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    previousToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">OnReload</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·çš„è¯è·å–Tokençš„å®ç°å°±éå¸¸ç®€å•äº†ï¼Œç›´æ¥è¿”å›ConfigurationReloadTokençš„å±æ€§å³å¯ä¸å†éœ€è¦ä¸€å †é¢å¤–çš„æ“ä½œï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ¯æ¬¡é€šè¿‡GetReloadTokenæ–¹æ³•è·å–çš„IChangeTokenå®ä¾‹éƒ½æ˜¯æœªå¤±æ•ˆçš„ã€‚</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> IChangeToken</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> GetReloadToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#ABB2BF;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> _changeToken</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><p>æœ¬æ–‡æˆ‘ä»¬è®²è§£äº†ChangeTokenç›¸å…³çš„ä½“ç³»ï¼Œè®¾è®¡åˆ°äº†IChangeTokenæ¥å£çš„å‡ ä¸ªå®ç°ç±»å’ŒChangeTokené™æ€ç±»æ˜¯å¦‚ä½•å®ç°é€šè¿‡å–æ¶ˆä»¤ç‰Œé‡å¤è§¦å‘çš„ï¼Œå…¶å®æœ¬è´¨ä¹Ÿå°±æ˜¯å®ƒçš„åå­—ï¼Œå¯ä»¥åŠ¨æ€å»æ›´æ”¹ä»¤ç‰Œï¼Œå®ç°çš„å¤§è‡´æ€è·¯å°±æ˜¯ç±»ä¼¼é€’å½’çš„æ“ä½œï¼Œåœ¨å›è°ƒé€šçŸ¥é‡Œè·å–æ–°çš„å˜æ›´ä»¤ç‰Œå®ä¾‹ï¼Œé‡æ–°æ³¨å†Œå½“å‰å›è°ƒæ“ä½œå½¢æˆé€’å½’ã€‚å› ä¸ºIChangeTokenå®ä¾‹éƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œè€Œæˆ‘ä»¬ä¼ é€’çš„CancellationTokenSourceå®ä¾‹ä¹Ÿæ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™æ²¡æ„Ÿè§‰æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œä½†å…¶å®å¦‚æœä½ æ¯æ¬¡æ‰“å°å®ƒçš„å®ä¾‹éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› ä¸ºå†…éƒ¨å·²ç»æ›´æ¢äº†æ–°çš„å®ä¾‹ã€‚å¥½äº†æˆ‘ä»¬å¤§è‡´æ€»ç»“ä¸€ä¸‹</p><p>â€¢IChangeTokenæ¥å£æ˜¯æ»¡è¶³ChangeTokené™æ€ç±»çš„å¿…é¡»æ“ä½œï¼Œé»˜è®¤æä¾›çš„CancellationChangeTokenç±»åˆ™æ˜¯IChangeTokenæ¥å£æœ€ç®€å•çš„å®ç°ï¼Œå®ƒæ˜¯ä¾èµ–CancellationTokenSourceå®ç°æ³¨å†Œå’Œå–æ¶ˆé€šçŸ¥ç›¸å…³æ“ä½œçš„ã€‚ â€¢ChangeTokené™æ€ç±»çš„å·¥ä½œä¾èµ–å®ƒçš„OnChangeæ–¹æ³•æ³¨å†Œçš„å‚æ•°ï¼Œä¸€ä¸ªæ˜¯è·å–IChangeTokenå®ä¾‹çš„å§”æ‰˜ï¼Œä¸€ä¸ªæ˜¯ä»¤ç‰Œå–æ¶ˆæ‰§è¡Œçš„æ“ä½œã€‚å…¶å®ç°çš„æœ¬è´¨æ˜¯åœ¨CancellationChangeTokençš„Registeræ–¹æ³•é‡Œæ³¨å†Œé‡æ–°æ³¨å†Œçš„æ“ä½œã€‚ä¹Ÿå°±æ˜¯é€šè¿‡ChangeTokené™æ€ç±»çš„OnChangeæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°å§”æ‰˜ï¼Œæ‰§è¡Œè¿™ä¸ªå§”æ‰˜è·å–æ–°çš„IChangeTokenå®ä¾‹ï¼Œå½“ç„¶å®ƒåŒ…å«çš„CancellationChangeTokenå®ä¾‹ä¹Ÿæ˜¯æœ€æ–°çš„ã€‚ç„¶åChangeTokené™æ€ç±»çš„OnChangeæ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³å›è°ƒæ“ä½œé‡æ–°æ³¨å†Œç»™è¿™ä¸ªæ–°çš„å®ä¾‹ï¼Œè¿™ä¸ªæ›´æ”¹æ“ä½œå¯¹å¤–éƒ¨éƒ½æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œä½†å…¶å®å†…éƒ¨æ—©å·²ç»æ›´æ¢äº†æ–°çš„å®ä¾‹ã€‚ â€¢CompositeChangeTokenå®ç°å…³è”å–æ¶ˆæ›´æ”¹æ“ä½œçš„æœ¬è´¨æ˜¯ï¼Œç»™ä¸€å †IChangeTokenå®ä¾‹æ³¨å†Œç›¸åŒçš„OnChangeæ“ä½œï¼Œå¦‚æœæœ‰ä¸€ä¸ªIChangeTokenå®ä¾‹æ‰§è¡Œäº†å–æ¶ˆåˆ™é€šè¿‡OnChangeæ–¹æ³•å–æ¶ˆå½“å‰CompositeChangeTokenå®ä¾‹å’Œç›¸å…³è”çš„IChangeTokenå®ä¾‹ï¼Œé˜²æ­¢åŒä¸€ä¸ªCompositeChangeTokenå®ä¾‹é‡å¤è¢«è§¦å‘ã€‚</p><p>è¿™ä¸ªç³»åˆ—æˆ‘ä»¬è®²è§£äº†å–æ¶ˆä»¤ç‰Œç›¸å…³ï¼Œå…¶æ ¸å¿ƒéƒ½æ˜¯å¯¹CancellationTokenSourceçš„åŒ…è£…ï¼Œå› ä¸ºé»˜è®¤çš„CancellationTokenSourceçš„å®ä¾‹é»˜è®¤åªèƒ½è¢«å–æ¶ˆä¸€æ¬¡ï¼Œä½†æ˜¯å¾ˆå¤šåœºæ™¯éœ€è¦èƒ½å¤šæ¬¡ç”šè‡³æ— é™æ¬¡è§¦å‘è¿™ç§é€šçŸ¥ï¼Œæ¯”å¦‚.Net Coreçš„Configurationä½“ç³»ï¼Œæ¯æ¬¡é…ç½®å‘ç”Ÿå˜æ›´éƒ½éœ€è¦æ‰§è¡Œå“åº”çš„åˆ·æ–°æ“ä½œã€‚å› æ­¤è¡ç”Ÿå‡ºæ¥äº†IChangeTokenç›¸å…³ï¼Œç»“åˆè¾…åŠ©çš„ChangeTokenæ¥å®ç°é‡å¤æ›´æ”¹ä»¤ç‰Œçš„æ“ä½œï¼Œå®ç°æ— é™æ¬¡çš„è§¦å‘é€šçŸ¥ã€‚è™½ç„¶åšä¸»èƒ½åŠ›å’Œæ–‡ç¬”éƒ½ååˆ†æœ‰é™ï¼Œä½†ä¾ç„¶å¸Œæœ›åŒå­¦ä»¬èƒ½ä»ä¸­è·å–æ”¶è·ï¼Œè¿™ä¹Ÿæ˜¯ä½œä¸ºå†™ä½œäººæœ€å¤§çš„åŠ¨åŠ›ã€‚</p><h2 id="å¼•ç”¨" tabindex="-1"><a class="header-anchor" href="#å¼•ç”¨"><span>å¼•ç”¨</span></a></h2><p>[1] æµ…è°ˆC#å–æ¶ˆä»¤ç‰ŒCancellationTokenSource: <em>https://www.cnblogs.com/wucy/p/15128365.html</em> [2] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/IChangeToken.cs</em> [3] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/CancellationChangeToken.cs</em> [4] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/ChangeToken.cs#L21</em> [5] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/ChangeToken.cs#L65</em> [6] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/ChangeToken.cs#L96</em> [7] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/ChangeToken.cs#L76</em> [8] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/ChangeToken.cs#L103</em> [9] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/ChangeToken.cs#L136</em> [10] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/CompositeChangeToken.cs#L26</em> [11] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/CompositeChangeToken.cs#L45</em> [12] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/CompositeChangeToken.cs#L105</em> [13] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Primitives/src/CompositeChangeToken.cs#L52</em> [14] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationReloadToken.cs</em> [15] ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ: <em>https://hub.fastgit.org/dotnet/runtime/blob/v5.0.9/src/libraries/Microsoft.Extensions.Configuration/src/ConfigurationRoot.cs#L117</em></p><h2 id="èµ„æ–™" tabindex="-1"><a class="header-anchor" href="#èµ„æ–™"><span>èµ„æ–™</span></a></h2><p><a href="https://mp.weixin.qq.com/s/BgWOCvyf3O851xlKQFkK0A" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/BgWOCvyf3O851xlKQFkK0A</a> | æµ…è°ˆC#æ›´æ”¹ä»¤ç‰ŒChangeToken</p>`,74),h=[l];function t(k,p){return n(),i("div",null,h)}const g=s(e,[["render",t],["__file","changetoken.html.vue"]]),c=JSON.parse('{"path":"/dotnet/csharp/threadConcurrencyAndAsync/async/changetoken.html","title":"ChangeToken","lang":"zh-CN","frontmatter":{"title":"ChangeToken","lang":"zh-CN","date":"2023-11-16T00:00:00.000Z","publish":true,"author":"azrng","isOriginal":true,"category":["csharp"],"tag":["æ— "],"filename":"changetoken","slug":"kz6h8i","docsId":"65939045","description":"å‰è¨€ åœ¨ä¸Šç¯‡æ–‡ç« æµ…è°ˆC#å–æ¶ˆä»¤ç‰ŒCancellationTokenSource[1]ä¸€æ–‡ä¸­æˆ‘ä»¬è®²è§£äº†CancellationTokenSourceï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ†å‘ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æˆ‘å–æ¶ˆä»¤ç‰Œæˆ‘å¯ä»¥è¿›è¡Œä¸€äº›å›è°ƒæ“ä½œæˆ–è€…é€šè¿‡ä»¤ç‰ŒçŠ¶æ€å¾—çŸ¥è¢«å–æ¶ˆã€‚åœ¨ä¸Šæ–‡çš„ç»“å°¾å¤„æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹CancellationTokenSourceäº§ç”Ÿçš„Tokenæ˜¯ä¸€æ¬¡æ€§çš„ï¼ŒC...","head":[["meta",{"property":"og:url","content":"https://azrng.gitee.io/kbms/kbms/dotnet/csharp/threadConcurrencyAndAsync/async/changetoken.html"}],["meta",{"property":"og:site_name","content":"çŸ¥è¯†åº“"}],["meta",{"property":"og:title","content":"ChangeToken"}],["meta",{"property":"og:description","content":"å‰è¨€ åœ¨ä¸Šç¯‡æ–‡ç« æµ…è°ˆC#å–æ¶ˆä»¤ç‰ŒCancellationTokenSource[1]ä¸€æ–‡ä¸­æˆ‘ä»¬è®²è§£äº†CancellationTokenSourceï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ†å‘ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æˆ‘å–æ¶ˆä»¤ç‰Œæˆ‘å¯ä»¥è¿›è¡Œä¸€äº›å›è°ƒæ“ä½œæˆ–è€…é€šè¿‡ä»¤ç‰ŒçŠ¶æ€å¾—çŸ¥è¢«å–æ¶ˆã€‚åœ¨ä¸Šæ–‡çš„ç»“å°¾å¤„æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹CancellationTokenSourceäº§ç”Ÿçš„Tokenæ˜¯ä¸€æ¬¡æ€§çš„ï¼ŒC..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-03-17T09:36:41.000Z"}],["meta",{"property":"article:author","content":"azrng"}],["meta",{"property":"article:tag","content":"æ— "}],["meta",{"property":"article:published_time","content":"2023-11-16T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-03-17T09:36:41.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ChangeToken\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-11-16T00:00:00.000Z\\",\\"dateModified\\":\\"2024-03-17T09:36:41.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"azrng\\"}]}"]]},"headers":[{"level":2,"title":"å‰è¨€","slug":"å‰è¨€","link":"#å‰è¨€","children":[]},{"level":2,"title":"ç®€å•å®ä¾‹","slug":"ç®€å•å®ä¾‹","link":"#ç®€å•å®ä¾‹","children":[{"level":3,"title":"CancellationChangeTokenç¤ºä¾‹","slug":"cancellationchangetokenç¤ºä¾‹","link":"#cancellationchangetokenç¤ºä¾‹","children":[]},{"level":3,"title":"CompositeChangeTokenç¤ºä¾‹","slug":"compositechangetokenç¤ºä¾‹","link":"#compositechangetokenç¤ºä¾‹","children":[]}]},{"level":2,"title":"æºç æ¢ç©¶","slug":"æºç æ¢ç©¶","link":"#æºç æ¢ç©¶","children":[{"level":3,"title":"IChangeTokenæ¥å£","slug":"ichangetokenæ¥å£","link":"#ichangetokenæ¥å£","children":[]},{"level":3,"title":"CancellationChangeTokenå®ç°","slug":"cancellationchangetokenå®ç°","link":"#cancellationchangetokenå®ç°","children":[]},{"level":3,"title":"ChangeTokenç±»çš„å®ç°","slug":"changetokenç±»çš„å®ç°","link":"#changetokenç±»çš„å®ç°","children":[]},{"level":3,"title":"CompositeChangeTokenå®ç°","slug":"compositechangetokenå®ç°","link":"#compositechangetokenå®ç°","children":[]}]},{"level":2,"title":"è‡ªå®šä¹‰IChangeTokenå®ç°","slug":"è‡ªå®šä¹‰ichangetokenå®ç°","link":"#è‡ªå®šä¹‰ichangetokenå®ç°","children":[]},{"level":2,"title":"æ€»ç»“","slug":"æ€»ç»“","link":"#æ€»ç»“","children":[]},{"level":2,"title":"å¼•ç”¨","slug":"å¼•ç”¨","link":"#å¼•ç”¨","children":[]},{"level":2,"title":"èµ„æ–™","slug":"èµ„æ–™","link":"#èµ„æ–™","children":[]}],"git":{"createdTime":1700232644000,"updatedTime":1710668201000,"contributors":[{"name":"azrng","email":"itzhangyunpeng@163.com","commits":1}]},"readingTime":{"minutes":23.25,"words":6974},"filePathRelative":"dotnet/csharp/threadConcurrencyAndAsync/async/changetoken.md","localizedDate":"2023å¹´11æœˆ16æ—¥","excerpt":"<h2>å‰è¨€</h2>\\n<p>åœ¨ä¸Šç¯‡æ–‡ç« æµ…è°ˆC#å–æ¶ˆä»¤ç‰ŒCancellationTokenSource[1]ä¸€æ–‡ä¸­æˆ‘ä»¬è®²è§£äº†CancellationTokenSourceï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ†å‘ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æˆ‘å–æ¶ˆä»¤ç‰Œæˆ‘å¯ä»¥è¿›è¡Œä¸€äº›å›è°ƒæ“ä½œæˆ–è€…é€šè¿‡ä»¤ç‰ŒçŠ¶æ€å¾—çŸ¥è¢«å–æ¶ˆã€‚åœ¨ä¸Šæ–‡çš„ç»“å°¾å¤„æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹CancellationTokenSourceäº§ç”Ÿçš„Tokenæ˜¯ä¸€æ¬¡æ€§çš„ï¼ŒCancelæ“ä½œä¹‹åå°±æ²¡åŠæ³•å†å¤ç”¨äº†ï¼Œåªèƒ½é‡Šæ”¾æ‰äº†ã€‚è€Œå¾®è½¯ä¹Ÿå¾ˆè´´å¿ƒçš„ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ¥è§£å†³è¿™é—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è¯´çš„æ›´æ”¹ä»¤ç‰ŒChangeTokenï¼Œå®ƒçœ‹èµ·æ¥å¯ä»¥è®©CancellationTokenSourceäº§ç”Ÿçš„Tokenå¤šæ¬¡è§¦å‘ï¼Œæœ¬æ–‡æˆ‘ä»¬å°±æ¥è®²è§£ChangeTokenç›¸å…³ã€‚</p>","autoDesc":true}');export{g as comp,c as data};
